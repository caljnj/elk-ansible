

# create the certs

in the script, first change vars file to test/prodcution as needed.

```yaml
- name: Create transport certs using docker and add them to vault
  hosts: all
  vars_files:
    - ../../vars/test/test-vars.yml
```

then use the script below, changing the _inventories_ section to test/production as needed.

it will then create all the certs and place them into `vault/{{ sitename }}/transport-certs/certs`

    ANSIBLE_GATHERING=explicit ANSIBLE_HOST_KEY_CHECKING=False ANSIBLE_FORKS=10 ansible-playbook -i inventories/test/test-inventory.yml test-setup/add-transport-to-vault/create-add-transport-certs-to-vault.yml --ask-vault-pass

note that `gather_facts` is disabled using the 

# encrypt the certs

encrypting the transport certs is a little different as inside the `certs` folder we get an individual folder per-server. and then the p12 file is inside there. 

So we need to use `find` to discover all the files, then apply the encrypt command to each one.

first copy the ansible vault password to file

    vi ~/.ansible_vault_pass

paste the password and save. then change permissions

    chmod 400 ~/.ansible_vault_pass

then cd into the directory `vault/transport-certs/certs` 

    for i in $(find . -type f); do ansible-vault encrypt $i  --vault-password-file ~/.ansible_vault_pass && echo $i encrypted ; done

it will print out stuff like: 

    Encryption successful
    ./someserver/someserver.p12 encrypted

# what does this do

this operation creates the "transport certificates" that will be used for the elasticsearch servers (i.e. not kibana/logstash/xx) to authenticate against each other, and encrypt info sent between them.

the command produces a pkcs12 **for each server**. and these files are encrypted with a password. 

NOTE: i've used default cleartext password here because this pkcs12 will be ansible vault encrypted before uploading into the git repo. 

inside each server's pkcs12 is a pkcs7 "bag" which holds: 

- the CA cert in CER format
- the individual server's cert file in CER format
- the matching keyfile for the above cert 

to see this yourself export the pkcs12 liek this: 

    openssl pkcs12 -info -in someserver.p12 -nodes

then to see what's in each cert you have to grab each CER file (between the _BEGIN_CERTIFICATE_ and _END_CERTIFICATE lines), paste each in a separate file then run the commands: 

    openssl x509 -in somefile -text | more

and what you will get the individual server's cert with header like this: 


    Version: 3 (0x2)
    Serial Number:
        xx:xx.xx:xx:xx
    Signature Algorithm: sha256WithRSAEncryption
    Issuer: CN = Elastic Certificate Tool Autogenerated CA
    Validity
        Not Before: Jan  2 22:24:01 2025 GMT
        Not After : Jan  2 22:24:01 2028 GMT
    Subject: CN = somserver
    Subject Public Key Info:

and running the same command on the CA cert encoded text, you'll get an output like this: 

    Version: 3 (0x2)
    Serial Number:
        xx:xx:xx:xx:xx
    Signature Algorithm: sha256WithRSAEncryption
    Issuer: CN = Elastic Certificate Tool Autogenerated CA
    Validity
        Not Before: Jan  2 22:23:59 2025 GMT
        Not After : Jan  2 22:23:59 2028 GMT
    Subject: CN = Elastic Certificate Tool Autogenerated CA
    Subject Public Key Info:
        Public Key Algorithm: rsaEncryption
            Public-Key: (2048 bit)

# how are these used? 

these are then sucked into the configuration so that they are used inside the elasticsearch.yml.j2. 

Note that the fields `xpack.security.transport.ssl.keystore.path` `xpack.security.transport.ssl.truststore.path` simply point to the same file:

    transport.ssl:
      enabled: true
      keystore.path: {{ es_ssl_certificate_path }}/{{ inventory_hostname }}.p12
      truststore.path: {{ es_ssl_certificate_path }}/{{ inventory_hostname }}.p12

this is because of this table. 

|item | cert type | definition
|----|-----|-----|
|truststore| transport |  this contains the self-signed "CA" cert for the transport certs generated with `./bin/elasticsearch-certutil ca --pem` and added to the file using `keytool -keystore ...` |
| keystore | transport | this is contains the **individual certificates + key for each server** that are generated using the truststore cert as root cert using `./bin/elasticsearch-certutil cert` |
| keystore | http | this contains the **individual certificates for each server** that are generated using the corporate CA cert as root cert

so essentially we can point the at one single pkcs12 that includes: 

- CA cert
- server cert
- server key